#include <pic32mx.h>
#include "mipslab.h"
#include "tetris_visual.h"
#include <stdint.h>
#include "tetrominoes.h"

// Digits 0-9
Bitmap digits = {
  4,
  50,
  {
    // 0
    0, 1, 0, 0,
    1, 0, 1, 0,
    1, 0, 1, 0,
    1, 0, 1, 0,
    0, 1, 0, 0,
    // 1
    0, 1, 0, 0,
    1, 1, 0, 0,
    0, 1, 0, 0,
    0, 1, 0, 0,
    1, 1, 1, 0,
    // 2
    0, 1, 0, 0,
    1, 0, 1, 0,
    0, 0, 1, 0,
    0, 1, 0, 0,
    1, 1, 1, 0,
    // 3
    1, 1, 0, 0,
    0, 0, 1, 0,
    0, 1, 0, 0,
    0, 0, 1, 0,
    1, 1, 0, 0,
    // 4
    1, 0, 1, 0,
    1, 0, 1, 0,
    1, 1, 1, 0,
    0, 0, 1, 0,
    0, 0, 1, 0,
    // 5
    1, 1, 1, 0,
    1, 0, 0, 0,
    1, 1, 0, 0,
    0, 0, 1, 0,
    1, 1, 0, 0,
    // 6
    0, 1, 1, 0,
    1, 0, 0, 0,
    1, 1, 1, 0,
    1, 0, 1, 0,
    0, 1, 0, 0,
    // 7
    1, 1, 1, 0,
    0, 0, 1, 0,
    0, 0, 1, 0,
    0, 0, 1, 0,
    0, 0, 1, 0,
    // 8
    0, 1, 0, 0,
    1, 0, 1, 0,
    0, 1, 0, 0,
    1, 0, 1, 0,
    0, 1, 0, 0,
    // 9
    0, 1, 0, 0,
    1, 0, 1, 0,
    0, 1, 1, 0,
    0, 0, 1, 0,
    0, 1, 0, 0,
  }
};
// Coontainer for nextblock
Bitmap nextContainer = {
    16,
    20,
    {
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
    }
};
// KTH Title CHAR
Bitmap kthTitle = {
    20,
    60,
    {
        // T
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1,
        // E
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0,
        0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0,
        0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0,
        0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0,
        0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0,
        0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        // T
        
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0,
        0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0,
    }
};
// Subblock to make tetromino bigger in display
Bitmap block = {
  3,
  3,
  {
    1, 1, 1,
    1, 1, 1,
    1, 1, 1,
  }
};

// Display that will hold all pixel data - 127 x 32 or 4096 pixels
uint8_t display[128 * 32];

// The board for the gamelogic
uint8_t boardLogic[10 * 20];

// Clears the display array to all 0
void display_clear(void) {

  int i;
  for (i = 0; i < 128 * 32; ++i) {
    display[i] = 0;
  }
}
// Updates the display in 4 iterations
void display_update(void) {

  uint8_t display_change[512]; // 512 x 8 = 4096 pixels each element is 8 bit data
  int i, j, k;
  for (i = 0; i < 512; ++i)
    display_change[i] = 0;
  
  // Display sends data in 4 pages each page being 8 bits and 128 bits per column 
  for (i = 0; i < 4; ++i) { // Page
    for (j = 0; j < 128; ++j) { // Column
      uint8_t compact = 0;  // 8 bit Integer
      for (k = 0; k < 8; ++k) {
        compact |= (display[i * 1024 + (k * 128) + j] & 0x1) << k;
      }
      display_change[i * 128 + j] = compact;
    }
    // SPI D/C mode low - command mode
    DISPLAY_CHANGE_TO_COMMAND_MODE;
    
    spi_send_recv(0x22);
    // Select page
    spi_send_recv(i);
    

    spi_send_recv(0x00);
    spi_send_recv(0x10);
    
    // SPI D/C mode high - data mode
    DISPLAY_CHANGE_TO_DATA_MODE;
    
    // 512 divided in 4 pages = 128
    for (j = 0; j < 128; ++j) {
      spi_send_recv(display_change[i * 128 + j]);
    }
  }
}
// Display bitmap in certain (x.y) position
void display_bitmap_pos(int x, int y, const Bitmap *bitmap, int w, int h, int ox, int oy) {
  
  // Default to the bitmap width and height if the values for w,h = 1
  if (w == 1) w = bitmap->width;
  if (h == 1) h = bitmap->height;
  
  int i, j;
  for (i = 0; i < h; ++i) {
    for (j = 0; j < w; ++j) {
      
      display[(x + j) * 128 + 127 - (y + i)] = bitmap->data[(oy + i) * bitmap->width + ox + j];

    }
  }
}
// Display bitmap with Bitmap width and height
void display_bitmap(int x, int y, const Bitmap *bitmap) {
  display_bitmap_pos(x, y, bitmap, 1, 1, 0, 0);
}
// Display the block from Blocks (x,y) position
void display_block(const Block *b) {
  int i, j;
  for (i = 0; i < b->height; ++i) {
    for (j = 0; j < b->width; ++j) {
      if (b->data[i * b->width + j])
        // Draw the subblock relative to the board (x=1, y=68)
        display_bitmap(1 + (b->x + j) * 3, 68 + (b->y + i) * 3, &block);
    }
  }
}
// Display the block in fixed (x,y) position
void display_block_pos(const Block *b, int x, int y) {
  int i, j;
  for (i = 0; i < b->height; ++i) {
    for (j = 0; j < b->width; ++j) {
      if (b->data[i * b->width + j])
        display_bitmap(x + j * 3, y + i * 3, &block);
    }
  }
}
// Display function for score and highscore
void display_score(int x, int y, unsigned int score) {
  // Negative scores not allowed
  if (score <= 0) {
    display_bitmap_pos(x, y, &digits, 4, 5, 0, 0);
    return;
  }

  int tmp = score;
  int count = 0;

  while (tmp > 0) {
    tmp /= 10;
    ++count;
  }

  // Draw the digits one by one
  int i;
  for (i = count - 1; i >= 0; --i) {
    int digit = score % 10;
    score /= 10;

    display_bitmap_pos(x + i * 4, y, &digits, 4, 5, 0, digit * 5);
  }
}

